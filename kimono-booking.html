<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>手動予約入力</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@200;300;400&family=Noto+Sans+JP:wght@300;400&family=DM+Mono:wght@300&display=swap" rel="stylesheet">
<style>
:root {
  --ink:    #1c1a18;
  --paper:  #faf8f4;
  --cream:  #f2ede4;
  --line:   #e0d9ce;
  --muted:  #9a9080;
  --accent: #8b3a3a;
  --gold:   #b8882a;
  --green:  #4a6741;
  --bg:     #efecea;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--ink); font-family: 'Noto Sans JP', sans-serif; font-weight: 300; min-height: 100vh; }

/* PINスクリーン */
#pin-screen {
  position: fixed; inset: 0; z-index: 9999;
  background: #1c1a18;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 24px;
}
#pin-screen h1 { color: #faf8f4; font-family: serif; font-weight: 200; font-size: 1.3rem; letter-spacing: 0.15em; margin: 0; }
#pin-display { display: flex; gap: 12px; }
#pin-display span { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #8b3a3a; background: transparent; transition: background 0.2s; }
#pin-display span.filled { background: #8b3a3a; }
#pin-keypad { display: grid; grid-template-columns: repeat(3, 64px); gap: 12px; }
#pin-keypad button { width: 64px; height: 64px; border-radius: 50%; border: 1px solid #3a3530; background: #2a2520; color: #faf8f4; font-size: 1.3rem; cursor: pointer; transition: background 0.15s; }
#pin-keypad button:active { background: #8b3a3a; }
#pin-error { color: #8b3a3a; font-size: 0.85rem; min-height: 1.2em; }

/* ヘッダー */
.header {
  background: var(--ink); color: var(--paper);
  padding: 18px 28px; display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 100;
}
.header h1 { font-family: 'Noto Serif JP', serif; font-weight: 200; font-size: 1.05rem; letter-spacing: 0.15em; }
.header-sub { font-family: 'DM Mono', monospace; font-size: 0.62rem; color: rgba(255,255,255,0.45); margin-top: 2px; }
.back-btn {
  background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
  color: var(--paper); padding: 7px 14px; border-radius: 2px;
  font-size: 0.78rem; cursor: pointer; text-decoration: none; display: inline-block;
  transition: background 0.2s;
}
.back-btn:hover { background: rgba(255,255,255,0.2); }

/* フォームエリア */
.form-wrap {
  max-width: 680px; margin: 36px auto; padding: 0 20px 60px;
}

.form-card {
  background: var(--paper); border: 1px solid var(--line); border-radius: 2px;
  overflow: hidden; margin-bottom: 20px;
}
.form-section-title {
  background: var(--cream); padding: 12px 20px;
  font-size: 0.72rem; letter-spacing: 0.12em; color: var(--muted);
  border-bottom: 1px solid var(--line);
}

.form-row {
  padding: 14px 20px; border-bottom: 1px solid var(--line);
  display: flex; align-items: flex-start; gap: 16px;
}
.form-row:last-child { border-bottom: none; }

.form-label {
  min-width: 100px; font-size: 0.82rem; color: var(--muted);
  padding-top: 9px; flex-shrink: 0;
}
.form-label .req { color: var(--accent); font-size: 0.65rem; margin-left: 3px; }

.form-input {
  flex: 1;
}
.form-input input,
.form-input select,
.form-input textarea {
  width: 100%; border: 1px solid var(--line); border-radius: 2px;
  padding: 8px 12px; font-family: 'Noto Sans JP', sans-serif; font-size: 0.85rem;
  font-weight: 300; color: var(--ink); background: var(--paper);
  transition: border-color 0.15s; outline: none;
}
.form-input input:focus,
.form-input select:focus,
.form-input textarea:focus { border-color: var(--accent); }
.form-input textarea { resize: vertical; min-height: 72px; }
.form-input select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M6 8L0 0h12z' fill='%239a9080'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }

/* 人数グリッド */
.people-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.people-item label { font-size: 0.72rem; color: var(--muted); display: block; margin-bottom: 4px; }
.people-item input { width: 100%; border: 1px solid var(--line); border-radius: 2px; padding: 7px 10px; font-size: 0.85rem; text-align: center; outline: none; }
.people-item input:focus { border-color: var(--accent); }

/* オプション */
.options-list { display: flex; flex-direction: column; gap: 8px; }
.option-row { display: flex; gap: 8px; align-items: center; }
.option-row input.opt-name { flex: 1; }
.option-row input.opt-price { width: 110px; }
.option-row .opt-del { background: none; border: 1px solid #ddd; color: var(--muted); width: 32px; height: 32px; border-radius: 2px; cursor: pointer; font-size: 1rem; flex-shrink: 0; transition: all 0.15s; }
.option-row .opt-del:hover { border-color: #c0392b; color: #c0392b; }
.add-opt-btn { background: none; border: 1px dashed var(--line); color: var(--muted); padding: 7px 14px; border-radius: 2px; font-size: 0.78rem; cursor: pointer; width: 100%; margin-top: 4px; transition: all 0.15s; }
.add-opt-btn:hover { border-color: var(--accent); color: var(--accent); }

/* 送信ボタン */
.submit-area { text-align: center; margin-top: 28px; }
.submit-btn {
  background: var(--accent); color: white; border: none;
  padding: 14px 48px; border-radius: 2px; font-size: 0.9rem;
  font-family: 'Noto Sans JP', sans-serif; letter-spacing: 0.1em;
  cursor: pointer; transition: opacity 0.2s;
}
.submit-btn:hover { opacity: 0.85; }
.submit-btn:disabled { opacity: 0.5; cursor: default; }

/* 成功メッセージ */
#successMsg {
  display: none; text-align: center; padding: 40px 20px;
  background: var(--paper); border: 1px solid var(--line); border-radius: 2px; margin-bottom: 20px;
}
#successMsg .check { font-size: 2.5rem; margin-bottom: 12px; }
#successMsg h2 { font-family: 'Noto Serif JP', serif; font-weight: 300; font-size: 1.1rem; margin-bottom: 8px; }
#successMsg p { font-size: 0.82rem; color: var(--muted); }
.new-entry-btn {
  display: inline-block; margin-top: 20px;
  background: var(--ink); color: white; border: none;
  padding: 10px 28px; border-radius: 2px; font-size: 0.85rem;
  cursor: pointer; transition: opacity 0.2s;
}
.new-entry-btn:hover { opacity: 0.8; }

/* 一覧 */
.list-toggle {
  text-align: center; margin-bottom: 16px;
}
.list-toggle-btn {
  background: none; border: 1px solid var(--line); color: var(--muted);
  padding: 8px 20px; border-radius: 2px; font-size: 0.78rem; cursor: pointer;
  transition: all 0.2s;
}
.list-toggle-btn:hover { border-color: var(--accent); color: var(--accent); }

#manualList { display: none; }
.manual-item {
  background: var(--paper); border: 1px solid var(--line); border-radius: 2px;
  padding: 14px 18px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: flex-start;
  font-size: 0.82rem;
}
.manual-item-info .mi-name { font-size: 0.9rem; margin-bottom: 2px; }
.manual-item-info .mi-sub { color: var(--muted); font-size: 0.73rem; }
.manual-item-del { background: none; border: none; color: #ccc; font-size: 1.1rem; cursor: pointer; padding: 2px 6px; transition: color 0.15s; }
.manual-item-del:hover { color: #c0392b; }
</style>
</head>
<body>
<div id="pin-screen">
  <h1>手動予約入力</h1>
  <div id="pin-display">
    <span></span><span></span><span></span><span></span><span></span><span></span>
  </div>
  <div id="pin-keypad">
    <button onclick="pinInput('1')">1</button><button onclick="pinInput('2')">2</button><button onclick="pinInput('3')">3</button>
    <button onclick="pinInput('4')">4</button><button onclick="pinInput('5')">5</button><button onclick="pinInput('6')">6</button>
    <button onclick="pinInput('7')">7</button><button onclick="pinInput('8')">8</button><button onclick="pinInput('9')">9</button>
    <button onclick="pinClear()" style="font-size:0.85rem;color:#9a9080;">C</button>
    <button onclick="pinInput('0')">0</button>
    <button onclick="pinDelete()" style="font-size:0.85rem;color:#9a9080;">⌫</button>
  </div>
  <div id="pin-error"></div>
</div>
<script>
(function(){
  const PIN='171005'; let entered='';
  if(sessionStorage.getItem('auth')==='ok') document.getElementById('pin-screen').style.display='none';
  window.pinInput=function(d){ if(entered.length>=6)return; entered+=d; updateDots();
    if(entered.length===6){ setTimeout(()=>{ if(entered===PIN){ sessionStorage.setItem('auth','ok'); document.getElementById('pin-screen').style.display='none'; } else { document.getElementById('pin-error').textContent='PINが違います'; entered=''; updateDots(); setTimeout(()=>document.getElementById('pin-error').textContent='',1500); } },100); } };
  window.pinDelete=function(){ entered=entered.slice(0,-1); updateDots(); };
  window.pinClear=function(){ entered=''; updateDots(); };
  function updateDots(){ document.querySelectorAll('#pin-display span').forEach((d,i)=>d.classList.toggle('filled',i<entered.length)); }
})();
</script>

<div class="header">
  <div>
    <div class="header-sub">MANUAL BOOKING ENTRY</div>
    <h1>手動予約入力</h1>
  </div>
  <a href="kimono-calendar.html" class="back-btn">← カレンダーへ戻る</a>
</div>

<div class="form-wrap">
  <!-- 成功メッセージ -->
  <div id="successMsg">
    <div class="check">✓</div>
    <h2>予約を保存しました</h2>
    <p id="successDetail"></p>
    <button class="new-entry-btn" onclick="resetForm()">続けて入力する</button>
  </div>

  <!-- 入力フォーム -->
  <form id="bookingForm" onsubmit="handleSubmit(event)">

    <!-- 基本情報 -->
    <div class="form-card">
      <div class="form-section-title">基本情報</div>

      <div class="form-row">
        <div class="form-label">来店日<span class="req">*</span></div>
        <div class="form-input">
          <input type="date" id="fDate" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-label">来店時間<span class="req">*</span></div>
        <div class="form-input">
          <select id="fTime" required>
            <option value="">-- 選択 --</option>
            <option>09:00</option><option>09:30</option>
            <option>10:00</option><option>10:30</option>
            <option>11:00</option><option>11:30</option>
            <option>12:00</option><option>12:30</option>
            <option>13:00</option><option>13:30</option>
            <option>14:00</option><option>14:30</option>
            <option>15:00</option><option>15:30</option>
            <option>16:00</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-label">お名前<span class="req">*</span></div>
        <div class="form-input">
          <input type="text" id="fName" placeholder="例：山田 花子" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-label">プラン<span class="req">*</span></div>
        <div class="form-input">
          <select id="fPlan" required>
            <option value="">-- 選択 --</option>
            <option>ベーシック</option>
            <option>スタンダード</option>
            <option>プレミアム</option>
            <option>撮影付き</option>
            <option>加賀友禅</option>
            <option>成人式下見</option>
            <option>卒業式下見</option>
            <option>期間限定</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-label">受付方法</div>
        <div class="form-input">
          <select id="fChannel">
            <option value="電話">電話予約</option>
            <option value="店頭">店頭（飛び込み）</option>
            <option value="LINE">LINE</option>
            <option value="その他">その他</option>
          </select>
        </div>
      </div>
    </div>

    <!-- 人数 -->
    <div class="form-card">
      <div class="form-section-title">人数</div>
      <div class="form-row">
        <div class="form-input" style="width:100%;">
          <div class="people-grid">
            <div class="people-item">
              <label>女性（名）</label>
              <input type="number" id="pFemale" min="0" value="0" oninput="calcTotal()">
            </div>
            <div class="people-item">
              <label>男性（名）</label>
              <input type="number" id="pMale" min="0" value="0" oninput="calcTotal()">
            </div>
            <div class="people-item">
              <label>カップル（組）</label>
              <input type="number" id="pCouple" min="0" value="0" oninput="calcTotal()">
            </div>
            <div class="people-item">
              <label>小人（名）</label>
              <input type="number" id="pChild" min="0" value="0" oninput="calcTotal()">
            </div>
            <div class="people-item">
              <label>大人合計</label>
              <input type="text" id="pTotal" readonly style="background:#f7f4f0;color:var(--muted);">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- オプション -->
    <div class="form-card">
      <div class="form-section-title">オプション</div>
      <div class="form-row">
        <div class="form-input" style="width:100%;">
          <div class="options-list" id="optionsList"></div>
          <button type="button" class="add-opt-btn" onclick="addOption()">＋ オプションを追加</button>
        </div>
      </div>
    </div>

    <!-- 金額・支払 -->
    <div class="form-card">
      <div class="form-section-title">金額・支払方法</div>

      <div class="form-row">
        <div class="form-label">合計金額</div>
        <div class="form-input" style="display:flex;align-items:center;gap:8px;">
          <span style="color:var(--muted);font-size:0.9rem;">¥</span>
          <input type="number" id="fTotal" min="0" placeholder="0" style="flex:1;">
        </div>
      </div>

      <div class="form-row">
        <div class="form-label">支払方法</div>
        <div class="form-input">
          <select id="fPayment">
            <option value="">未定</option>
            <option value="現地決済（現金）">現地決済（現金）</option>
            <option value="現地決済（カード）">現地決済（カード）</option>
            <option value="事前クレジット決済">事前クレジット決済</option>
            <option value="PayPay">PayPay</option>
            <option value="その他">その他</option>
          </select>
        </div>
      </div>
    </div>

    <!-- 連絡先 -->
    <div class="form-card">
      <div class="form-section-title">お客様情報</div>

      <div class="form-row">
        <div class="form-label">電話番号</div>
        <div class="form-input">
          <input type="tel" id="fTel" placeholder="090-0000-0000">
        </div>
      </div>

      <div class="form-row">
        <div class="form-label">メール</div>
        <div class="form-input">
          <input type="email" id="fEmail" placeholder="example@mail.com">
        </div>
      </div>

      <div class="form-row">
        <div class="form-label">備考</div>
        <div class="form-input">
          <textarea id="fRemarks" placeholder="アレルギー、着付け希望時間、その他メモなど"></textarea>
        </div>
      </div>
    </div>

    <div class="submit-area">
      <button type="submit" class="submit-btn" id="submitBtn">予約を保存する</button>
    </div>
  </form>

  <!-- 登録済み手動予約一覧 -->
  <div class="list-toggle">
    <button class="list-toggle-btn" onclick="toggleList()">登録済みの手動予約を確認する ▾</button>
  </div>
  <div id="manualList"></div>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbx347zA3An_FRMxeBLEQVLCbGRgLBiUinEt8OL2I-H91ixNlqwT6lXb-9-_rP_ZowrbKw/exec';
const ACCESS_KEY = 'AkariKimono2026_mK9x';

async function postToGAS(action, payload) {
  const body = JSON.stringify({ key: ACCESS_KEY, action, ...payload });
  const res = await fetch(GAS_URL, {
    method: 'POST',
    body,
    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
  });
  return JSON.parse(await res.text());
}

// ── 人数合計 ──
function calcTotal() {
  const f = parseInt(document.getElementById('pFemale').value)||0;
  const m = parseInt(document.getElementById('pMale').value)||0;
  const c = (parseInt(document.getElementById('pCouple').value)||0) * 2;
  const ch = parseInt(document.getElementById('pChild').value)||0;
  document.getElementById('pTotal').value = (f + m + c + ch) + '名';
}
calcTotal();

// ── オプション追加 ──
let optCount = 0;
function addOption(name='', price='') {
  optCount++;
  const id = 'opt_' + optCount;
  const row = document.createElement('div');
  row.className = 'option-row';
  row.id = id;
  row.innerHTML = `
    <input class="opt-name" type="text" placeholder="オプション名（例：ヘアセット）" value="${name}">
    <input class="opt-price" type="number" placeholder="金額（¥）" min="0" value="${price}">
    <button type="button" class="opt-del" onclick="document.getElementById('${id}').remove()">×</button>
  `;
  document.getElementById('optionsList').appendChild(row);
}

// ── フォーム送信 ──
async function handleSubmit(e) {
  e.preventDefault();

  const f = parseInt(document.getElementById('pFemale').value)||0;
  const m = parseInt(document.getElementById('pMale').value)||0;
  const c = parseInt(document.getElementById('pCouple').value)||0;
  const ch = parseInt(document.getElementById('pChild').value)||0;
  const totalPeople = f + m + c * 2 + ch;

  if (totalPeople === 0) { alert('人数を入力してください'); return; }

  // 人数テキスト生成
  const parts = [];
  if (f > 0)  parts.push(`女性${f}名`);
  if (m > 0)  parts.push(`男性${m}名`);
  if (c > 0)  parts.push(`カップル${c}組`);
  if (ch > 0) parts.push(`小人${ch}名`);
  const peopleStr = parts.join('・');

  // オプション収集
  const optRows = document.querySelectorAll('#optionsList .option-row');
  const options = [];
  optRows.forEach(row => {
    const n = row.querySelector('.opt-name').value.trim();
    const p = parseInt(row.querySelector('.opt-price').value)||0;
    if (n) options.push({ name: n, price: p });
  });

  const now = new Date();
  const id = 'MANUAL-' + now.getTime();

  const booking = {
    id,
    reservationId: id,
    source: 'MANUAL',
    date:   document.getElementById('fDate').value,
    time:   document.getElementById('fTime').value,
    name:   document.getElementById('fName').value.trim(),
    plan:   document.getElementById('fPlan').value,
    channel: document.getElementById('fChannel').value,
    people: peopleStr,
    options,
    total:   parseInt(document.getElementById('fTotal').value)||0,
    payment: document.getElementById('fPayment').value,
    tel:     document.getElementById('fTel').value.trim(),
    email:   document.getElementById('fEmail').value.trim(),
    remarks: document.getElementById('fRemarks').value.trim(),
    createdAt: now.toISOString(),
  };

  // GASへ保存（失敗時はlocalStorageにフォールバック）
  const btn = document.getElementById('submitBtn');
  btn.disabled = true; btn.textContent = '保存中...';
  try {
    await postToGAS('save', { booking });
  } catch(err) {
    console.warn('GAS保存失敗、localStorageに保存:', err);
    const manuals = JSON.parse(localStorage.getItem('kimono_manual_bookings') || '[]');
    manuals.push(booking);
    localStorage.setItem('kimono_manual_bookings', JSON.stringify(manuals));
  }
  btn.disabled = false; btn.textContent = '予約を保存する';

  // 成功表示
  document.getElementById('bookingForm').style.display = 'none';
  const sd = document.getElementById('successMsg');
  sd.style.display = 'block';
  const d = new Date(booking.date + 'T00:00:00');
  const days = ['日','月','火','水','木','金','土'];
  document.getElementById('successDetail').textContent =
    `${d.getMonth()+1}月${d.getDate()}日（${days[d.getDay()]}） ${booking.time}  ${booking.name} 様  ${booking.plan}`;
}

function resetForm() {
  document.getElementById('bookingForm').reset();
  document.getElementById('optionsList').innerHTML = '';
  calcTotal();
  document.getElementById('bookingForm').style.display = 'block';
  document.getElementById('successMsg').style.display = 'none';
  // 今日の日付をデフォルトにセット
  document.getElementById('fDate').value = new Date().toISOString().slice(0,10);
}

// ── 一覧表示 ──
let listVisible = false;
function toggleList() {
  listVisible = !listVisible;
  const el = document.getElementById('manualList');
  el.style.display = listVisible ? 'block' : 'none';
  if (listVisible) renderList();
}

function renderList() {
  const el = document.getElementById('manualList');
  const manuals = JSON.parse(localStorage.getItem('kimono_manual_bookings') || '[]');
  if (manuals.length === 0) {
    el.innerHTML = '<p style="text-align:center;color:var(--muted);font-size:0.82rem;padding:20px;">登録済みの手動予約はありません</p>';
    return;
  }
  // 日付降順
  const sorted = [...manuals].sort((a,b) => b.date.localeCompare(a.date));
  el.innerHTML = sorted.map(b => {
    const d = new Date(b.date + 'T00:00:00');
    const days = ['日','月','火','水','木','金','土'];
    return `<div class="manual-item">
      <div class="manual-item-info">
        <div class="mi-name">${b.name} 様</div>
        <div class="mi-sub">${d.getMonth()+1}月${d.getDate()}日（${days[d.getDay()]}） ${b.time} ／ ${b.plan} ／ ${b.people}
          ${b.total > 0 ? ' ／ ¥' + b.total.toLocaleString() : ''}
          ${b.channel ? ' ／ ' + b.channel : ''}
        </div>
      </div>
      <button class="manual-item-del" onclick="deleteManual('${b.id}')">✕</button>
    </div>`;
  }).join('');
}

async function deleteManual(id) {
  if (!confirm('この手動予約を削除しますか？')) return;
  try {
    await postToGAS('delete', { id });
  } catch(err) {
    console.warn('GAS削除失敗:', err);
  }
  // localStorageフォールバックからも削除
  let manuals = JSON.parse(localStorage.getItem('kimono_manual_bookings') || '[]');
  manuals = manuals.filter(b => b.id !== id);
  localStorage.setItem('kimono_manual_bookings', JSON.stringify(manuals));
  renderList();
}

// 初期日付セット
document.getElementById('fDate').value = new Date().toISOString().slice(0,10);
</script>
</body>
</html>
